---
- name: Install prerequisite packages
  ansible.builtin.package:
    name:
      - docker-ce
      - python3-pip
    state: present

- name: Create docker volumes
  community.docker.docker_volume:
    name: "{{ item }}"
  with_items: "{{ volumes }}"
  when: volumes is defined and volumes | length > 0

- name: Log into private registry and force re-authorization
  docker_login:
    registry_url: "{{ registry }}"
    username: "{{ registry_user | default('') }}"
    password: "{{ registry_pass | default('') }}"
  when: registry | string | length > 0

- name: Pull an image
  community.docker.docker_image:
    name: "{{ image }}"
    source: pull

- name: Create systemd service file
  template:
    src: "service_template.service.j2"
    dest: /etc/systemd/system/{{ service_name }}.service
  vars:
    service_name: "{{ service_name }}"
    image: "{{ image }}"
    docker_run_args: "{{ docker_run_args | default('') }}"
  notify:
    - enable docker service
    - restart docker service

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Ensure docker service is running and enabled
  ansible.builtin.systemd:
    name: "{{ docker_service_name }}.service"
    state: started
    enabled: yes